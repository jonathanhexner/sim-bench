# Face Clustering Benchmark Configuration
# Compares HDBSCAN vs Hybrid HDBSCAN+kNN clustering methods

# Output settings
output:
  results_dir: results/face_clustering_benchmark
  save_face_crops: true
  crop_size: 112  # Standard face recognition size

# HDBSCAN Method (Current default)
hdbscan:
  algorithm: hdbscan
  params:
    min_cluster_size: 2
    min_samples: 2
    cluster_selection_epsilon: 0.3
    metric: cosine

# Hybrid HDBSCAN+kNN Method (Exemplar-based with Tukey fence thresholds)
hybrid_knn:
  algorithm: hybrid_hdbscan_knn
  params:
    # HDBSCAN initial clustering
    min_cluster_size: 3
    min_samples: 2
    cluster_selection_epsilon: 0.35

    # Threshold computation (Tukey fence: T = Q3(d3) + 1.5*IQR, clamped to [floor, ceiling])
    knn_k: 3                    # k for d_k neighbor distance computation
    threshold_floor: 0.50       # Minimum threshold for any cluster
    threshold_ceiling: 0.90     # Maximum threshold for any cluster

    # Exemplar selection
    max_exemplars: 10           # Max exemplars per cluster (faces with smallest d3)

    # Merge criteria (clusters merge if enough cross-exemplar pairs are close)
    merge_min_pairs: 3          # Min exemplar pairs within threshold to merge
    merge_min_distinct: 2       # Min distinct exemplars from each cluster involved

    # Attachment criteria (noise points attach if close to enough exemplars)
    attach_min_exemplars: 2     # Min exemplars within threshold to attach

    # Iteration control
    max_iterations: 10          # Max merge+attach iterations

# Hybrid Closest-Face Method (NEW - allows intra-person variation)
hybrid_closest:
  algorithm: hybrid_closest_face
  params:
    min_cluster_size: 3
    min_samples: 2
    cluster_selection_epsilon: 0.35
    merge_threshold: 0.35  # Merge if faces this close
    merge_min_close_pairs: 2  # Need 2+ close pairs
    attach_threshold: 0.38  # Attach if close to any face

# Pipeline settings for face extraction
pipeline:
  steps:
    - discover_images
    - detect_persons
    - insightface_detect_faces
    - filter_faces
    - extract_face_embeddings
  
  # Filter faces configuration (same as main pipeline)
  filter_faces:
    min_confidence: 0.5
    min_bbox_ratio: 0.02
    min_relative_size: 0.3
    min_eye_ratio: 0.01
  
  # Face embedding configuration
  extract_face_embeddings:
    backend: insightface
    model_name: buffalo_l
    device: cpu
