# End-to-End ResNet50 Siamese Network Training
# Fine-tunes entire ResNet50 CNN backbone + MLP head

name: "siamese_e2e_resnet50"

# Model type: 'siamese_cnn' (our implementation) or 'reference' (Series-Photo-Selection)
model_type: "reference"

# Transform type: 'standard', 'paper', 'external', or 'auto' (auto-detect from config)
transform_type: "paper"

data:
  root_dir: "/workspace/triage"
  # When using external dataloader, specify the image_root (where train_val_imgs are)
  image_root: "D:\\Similar Images\\automatic_triage_photo_series\\train_val\\train_val_imgs"
  min_agreement: 0.7
  min_reviewers: 2
  split_mode: "series_based"
  quick_experiment: null  # Set to 0.1 for 10% of data

model:
  # Siamese CNN + MLP configuration
  cnn_backbone: "resnet50"
  pretrained: true
  use_paper_preprocessing: true  # Aspect-ratio preserving resize (matches reference)
  padding_mean_color: [0.485, 0.456, 0.406]  # ImageNet mean for padding

  # MLP head architecture - Match reference implementation (direct linear layer)
  mlp_hidden_dims: []  # Empty = direct 2048 â†’ 2 mapping
  dropout: 0.0
  activation: "relu"

training:
  batch_size: 8  # Match reference implementation
  learning_rate: 0.00001  # Base LR for backbone (1e-5), head gets 10x (1e-4)
  differential_lr: true  # Use 1x LR for backbone, 10x for head
  optimizer: "sgd"
  momentum: 0.9
  weight_decay: 0.0005
  max_epochs: 2  # Match reference implementation
  early_stop_patience: 10

output_dir:
device: "cuda"
seed: 42
log_interval: 100  # Log every N batches
# Telemetry configuration
telemetry:
  enabled: true
  collect_every_n: 100  # Collect metrics every 200 batches

  # Enable/disable individual metrics
  track_gradients: true
  track_weight_delta: true
  track_learning_rates: true
  track_holdout_logits: true
  track_batch_stats: true

  # Holdout settings
  holdout_size: 50  # Number of validation pairs to track
# Batch prediction logging (for debugging training differences)
log_batch_predictions: false  # Set to true to log per-batch predictions
log_predictions_every_n: 100  # Log every N batches (1 = all, 10 = every 10th)

# Model comparison (optional debugging)
compare_with_reference: false  # Set to true to compare with reference ResNet50 model at start
batch_comparison_interval: 100000  # Dump model state every N batches for comparison (null = disabled, e.g. 10)
use_external_dataloader: true
